services:
  # Web browser container
  web_browser_container:
    image: selenium/standalone-chrome:latest
    # image: selenium/standalone-chromium:latest
    # image: selenium/standalone-firefox:latest
    # image: selenium/standalone-edge:latest  # This image only work on windows 
    shm_size: 2gb # shared memory
    ports:
      - "4444:4444" # Expose Selenium port
      - "7900:7900" # Expose VNC port (password: secret)
    environment:
      # Fix the screen size so the video recorder knows exactly what to capture
      - SE_SCREEN_WIDTH=${SE_SCREEN_WIDTH}
      - SE_SCREEN_HEIGHT=${SE_SCREEN_HEIGHT}
      - SE_NODE_MAX_SESSION=${SE_NODE_MAX_SESSION}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4444/wd/hub/status"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Python script container
  bot:
    build: .
    depends_on:
      web_browser_container:
        condition: service_healthy
    environment:
      - SELENIUM_HOST=web_browser_container
    volumes:
      - ./main.py:/app/main.py # Mount script for easy editing

  # Video Recording Service
  video:
    image: selenium/video:latest
    volumes:
      - ./videos:/videos
    depends_on:
      - web_browser_container
    environment:
      - DISPLAY_CONTAINER_NAME=web_browser_container
      - SE_SCREEN_WIDTH=${SE_SCREEN_WIDTH}
      - SE_SCREEN_HEIGHT=${SE_SCREEN_HEIGHT}
      - FILE_NAME=${FILE_NAME}